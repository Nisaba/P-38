<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx"
					   applicationComplete="Init()"
					   width="100%" height="100%">

	
<fx:Script> 
	<![CDATA[ 
		import blockstream.Message;
		import flash.events.Event;
		import flash.events.ErrorEvent;
        import org.qrcode.QRCode;
        import lang.langConfig;
        import utils.myAppli;
        import blockstream.PrivateKey;
        import org.apache.flex.collections.VectorCollection;

		private var msg:Message;
		[Bindable] private var myMessages:Vector.<Message>;
		
		private var myKeys:Vector.<PrivateKey>;
		[Bindable] private var myKeysCollection:VectorCollection;

		[Bindable] private var Lang:langConfig;

		private function Init():void {
			Lang = langConfig.Factory(Capabilities.language);
			myMessages = myAppli.Messages;
			myKeys = myAppli.PrivateKeys;
			myKeysCollection = new VectorCollection(myKeys);
		}

		private function SendFile():void {
			var f:File = new File();
			f.addEventListener(Event.SELECT, onFileSelect);
			f.browseForOpen(Lang.SelectionFichier);

			function onFileSelect(e:Event):void {
				f.removeEventListener(Event.SELECT, onFileSelect);
				msg = new Message();
				msg.addEventListener(Event.COMPLETE, onMsgComplete);
				msg.addEventListener(ErrorEvent.ERROR, onMsgError);
				msg.SendFile(e.currentTarget as File, nmrSatoshi.value);
			}


		}

		private function SendMsg():void {
			if (txtMess.text.length == 0) return;
			
			msg = new Message();
			msg.addEventListener(Event.COMPLETE, onMsgComplete);
			msg.addEventListener(ErrorEvent.ERROR, onMsgError);
			if (chkSign.selected) {
				var myKey:PrivateKey = (cmbKeys.selectedItem as PrivateKey);
				msg.SendTxtCrypt(txtMess.text, nmrSatoshi.value, myKey.Key);
			} else {
				msg.SendTxt(txtMess.text, nmrSatoshi.value);
			}
		}

		private function onMsgComplete(e:Event):void {
			msg.removeEventListener(Event.COMPLETE, onMsgComplete);
			msg.removeEventListener(ErrorEvent.ERROR, onMsgError);
			txtLightning.text = msg.LightningInvoice;

			spriteQrCode.removeChildren();
			var qr:QRCode = new QRCode();
			qr.encode(msg.LightningInvoice);
			spriteQrCode.addChild(new Bitmap(qr.bitmapData));  	

			myMessages.push(msg);
			myAppli.Messages = myMessages;

		}

		private function onMsgError(e:ErrorEvent):void {
			msg.removeEventListener(Event.COMPLETE, onMsgComplete);
			msg.removeEventListener(ErrorEvent.ERROR, onMsgError);
			if (msg.ErrCode == 0) {
				trace (Lang.ErreurMsg + e.text);
			} else {
				trace (Lang.ErreurMsg + msg.ErrCode.toString() + " - " + Lang.ErrDescription[msg.ErrCode]);
				trace (msg.ErrMsg);
			}
		}		
	]]>
</fx:Script>

<fx:Declarations>
	<s:RadioButtonGroup id="rdTypeMessage"/>
</fx:Declarations>


<mx:TabNavigator id="myTab">
	<s:NavigatorContent width="100%" height="100%" label="{Lang.NewMsg}">
		<s:VGroup gap="20">
			<s:HGroup>
				<s:RadioButton group="{rdTypeMessage}" id="rdDroneEltPoint" label="{Lang.Texte}" value="txt" selected="true"/>
				<s:RadioButton group="{rdTypeMessage}" id="rdDroneEltChemin" label="{Lang.Fichier}" value="fic"/>
			</s:HGroup>
			<s:HGroup verticalAlign="middle">
				<s:CheckBox id="chkSign" label="{Lang.SignerMessage}" enabled="{cmbKeys.selectedItem != null}"/>
				<s:Spacer width="20"/>
				<s:Label text="{Lang.Cle}"/>
				<s:ComboBox id="cmbKeys" dataProvider="{myKeysCollection}" labelField="Desc"/>
			</s:HGroup>

			<s:TextInput id="txtMess" visible="{rdTypeMessage.selectedValue == 'txt'}"/>
			<s:Button label="{Lang.SelectionFichier}" click="SendFile()" visible="{rdTypeMessage.selectedValue == 'fic'}"/>

			<s:HGroup verticalAlign="middle">
				<s:Label text="mSatoshi / byte"/>
				<s:NumericStepper id="nmrSatoshi" value="1" minimum="1"/>
			</s:HGroup>

			<s:HGroup>
				<s:Button label="Refresh" click="msg.Refresh();"/>
				<s:Button label="{Lang.Envoyer}" click="if(rdTypeMessage.selectedValue == 'txt') SendMsg() else SendFile();"/>
			</s:HGroup>
			<s:TextArea id="txtLightning" width="500" height="300"/>
			<s:SpriteVisualElement id="spriteQrCode" width="250" height="250"/>
		</s:VGroup>
	</s:NavigatorContent>

	<s:NavigatorContent width="100%" height="100%" label="{Lang.MsgEnregistres}">
		<s:DataGrid alternatingRowColors="[#FFFFFF, #CCCCCC]" verticalScrollPolicy="auto" width="100%" height="180" fontSize="10"
				added="{myAppli.PrivateKeys = myKeys}" updateComplete="{myAppli.PrivateKeys = myKeys}">
			<s:columns>
				<s:ArrayList>
					<s:GridColumn dataField="DateT" headerText="{Lang.Date}" editable="false"/>
					<s:GridColumn dataField="ID" headerText="{Lang.ID}" editable="false"/>
					<s:GridColumn dataField="Token" headerText="{Lang.Description}" editable="false"/>
					<s:GridColumn dataField="Type" headerText="{Lang.Type}" editable="false"/>
					<s:GridColumn dataField="mSatoshi" headerText="{Lang.Cle}" editable="false"/>
					<s:GridColumn dataField="Status" headerText="{Lang.Description}" editable="false"/>
					<s:GridColumn dataField="IsCrypted" headerText="{Lang.Crypte}" editable="false"/>
					<s:GridColumn dataField="Content" headerText="{Lang.Contenu}" editable="false"/>
				</s:ArrayList>
			</s:columns>
		</s:DataGrid>		
	</s:NavigatorContent>

	<s:NavigatorContent width="100%" height="100%" label="{Lang.ClesPrivees}">
		<s:DataGrid alternatingRowColors="[#FFFFFF, #CCCCCC]" verticalScrollPolicy="auto" width="250" height="180" fontSize="10"
				added="{myAppli.PrivateKeys = myKeys}" updateComplete="{myAppli.PrivateKeys = myKeys}">
			<s:columns>
				<s:ArrayList>
					<s:GridColumn dataField="Desc" headerText="{Lang.Description}" editable="true"/>
					<s:GridColumn dataField="Key" headerText="{Lang.Cle}" editable="false"/>
				</s:ArrayList>
			</s:columns>
		</s:DataGrid>		
	</s:NavigatorContent>

	<s:NavigatorContent width="100%" height="100%" label="{Lang.ParamsLN}">
	</s:NavigatorContent>

</mx:TabNavigator>

</s:WindowedApplication>